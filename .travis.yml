sudo: required
dist: trusty

# Don't do shallow clones
git:
  depth: false

os:
  - osx
  - linux

language: csharp
mono: none
env:
  global:
    - DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
    - DOTNET_CLI_TELEMETRY_OPTOUT=1
    - COMPlus_UseManagedHttpClientHandler=true

# minikube-related changes
    - CHANGE_MINIKUBE_NONE_USER=true
    - MINIKUBE_WANTREPORTERRORPROMPT=false
    - MINIKUBE_WANTUPDATENOTIFICATION=false
    - KUBECONFIG=/home/travis/.kube/config

# We need the .NET Core 2.1 SDK to build. Travis doesn't know how to install this yet.
before_install:
  - ./install-$TRAVIS_OS_NAME.sh
  - dotnet tool install --tool-path tools coveralls.net --version 1.0.0
  - sudo apt-get install jq
  - wget -O ~/codacy-coverage-reporter-assembly-latest.jar $(curl https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r .assets[0].browser_download_url)

script:
  - ./ci.sh  

after_script:
  - REPO_COMMIT_AUTHOR=$(git show -s --pretty=format:"%cn")
  - REPO_COMMIT_AUTHOR_EMAIL=$(git show -s --pretty=format:"%ce")
  - REPO_COMMIT_MESSAGE=$(git show -s --pretty=format:"%s")
  - echo $TRAVIS_COMMIT
  - echo $TRAVIS_BRANCH
  - echo $REPO_COMMIT_AUTHOR
  - echo $REPO_COMMIT_AUTHOR_EMAIL
  - echo $REPO_COMMIT_MESSAGE
  - echo $TRAVIS_JOB_ID
  - ./codacy-unit-test.sh
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ./integration-tests.sh; fi

deploy:
  skip_cleanup: true
  provider: script
  script: dotnet nuget push src/KubernetesClient/bin/Release/KubernetesClient.*.nupkg --api-key $NUGET_API_KEY --source $NUGET_SOURCE
  on:
    branch: master
    condition: '"x${NUGET_API_KEY}" != "x" && "x$NUGET_SOURCE" != "x" && "$TRAVIS_OS_NAME" == "linux"'